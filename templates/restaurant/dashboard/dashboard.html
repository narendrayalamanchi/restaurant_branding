{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{request.session.brandname}} Menu</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href={% static 'css/authentication.css'%} rel="stylesheet" >
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.slim.min.js" integrity="sha512-sNylduh9fqpYUK5OYXWcBleGzbZInWj8yCJAU57r1dpSK9tP2ghf/SRYCMj+KsslFkCOt3TvJrX2AV/Gc3wOqA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
</head>
<body>
    
{% include 'restaurant/dashboard/header.html' %}
{% load custom_filters %}

    <!-- Main Layout -->
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Menu -->
            <aside class="col-3 col-md-2 bg-light p-4 border-end">
                <h6>Menu</h6>
                <!-- <p class="text-muted">Timings </p> -->
                <nav class="nav flex-column">
                    {% for item in menu  %}
                        <!--  <a href="#" class="nav-link text-dark fw-bold border-start border-dark ps-2">Specials</a> -->
                        {% if item.category.name != previous_category %}
                        <a href="#" class="nav-link text-dark"> {{item.category.name}} </a>
                        {% update_previous_category item.category.name %}
                        {% endif %}
                    {% endfor %}
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="col-9 col-md-10 p-4 main-menu-items">
                {% for item in menu  %}
                    {% if item.category.name != previous_category %}
                        {% if previous_category %}
                            </div> 
                        {% endif %}
                        <h2>{{item.category.name}}</h2>
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mt-3">
                        {% update_previous_category item.category.name %}
                    {% endif %}
                    <!-- Each Menu Items -->
                    <div class="col">
                        <div class="card h-100">
                            <div class="row g-0">
                                <div class="col-8">
                                    <div class="card-body">
                                        <h6 class="card-title">{{item.name}}</h6>
                                        <p class="card-text text-muted">${{item.price}}</p>
                                        <p class="card-text recipe-details">{{item.recipe_details}}</p>
                                    </div>
                                </div>
                                <div class="col-4 position-relative">
                                    <img src="{% get_aws_s3_base_url %}/{{item.image}}" alt="{{item.name}}" class="img-fluid" />
                                    <div class="display-quantity">
                                        <button class="quick-add-minus" onclick="removeitems_to_cart(this)" item-id="{{item.id}}">
                                            <i class="fa-solid fa-minus"></i>
                                        </button>
                                        <span class="quick-add-quantity"> {{ cart_items|get:item.id|default:0 }} </span>
                                        <button class="quick-add-plus" onclick="additems_to_cart(this)" item-id="{{item.id}}">
                                            <i class="fa-solid fa-plus"></i>
                                        </button>

                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor%}

                
                   
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const truncateElements = document.querySelectorAll('.recipe-details');
            
            truncateElements.forEach(element => {
                const originalText = element.innerText;
                if (originalText.length > 60) {
                    element.innerText = originalText.substring(0, 60) + '...';
                }
            });
        });

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Check if this cookie string begins with the name we want
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');

        function removeitems_to_cart(event){
         
            fetch("{% url 'remove_from_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({
                    item_id: $(event).attr("item-id")
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if(data.status == "success"){
                        $(event).prev().text(data.quantity);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }
        
        function additems_to_cart(event){
         
            fetch("{% url 'add_to_cart' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken 
                },
                body: JSON.stringify({
                    item_id: $(event).attr("item-id")
                }),
            })
                .then(response => response.json())
                .then(data => {
                    if(data.status == "success"){
                        $(event).prev().text(data.quantity);
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                });
        }

    </script>
</body>
</html>